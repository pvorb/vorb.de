<!DOCTYPE html>
<html lang="en" id="top">
  <head>
    <meta charset="utf-8">
    <title>File search in Node.js | vorb.de</title>
    <link rel="stylesheet" href="/res/milten.css">
    <link rel="icon" href="/favicon.ico">
    <link rel="alternate" type="application/atom+xml" href="/log/feed.xml"
      title="Article feed">
    <link rel="alternate" type="application/atom+xml"
      href="/log/comment-feed.xml" title="Comment feed">
    <link rel="pingback" href="http://vorb.de/log/pingback">
    <meta name="author" content="Paul Vorbach">

    <meta name="keywords" content="english, dev, nodejs">

  </head>
  <body>
    <header id="site">
      <a href="/" accesskey="h">vorb.de</a>
    </header>
    <nav id="nav">
      <ul id="branches">
        <li class="active"><a href="/log/" accesskey="l">Blog</a>
        <li><a href="/info/" accesskey="i">Info</a>
      </ul>
      <ol id="path">
        <li><a href="/">vorb.de</a>

        <li><a href="/log/">log</a>

        <li><a href="/log/2012/">2012</a>

        <li><a href="/log/2012/07/">07</a>

        <li>file-search-nodejs.html

      </ol>
      <ol id="access">
        <li><a href="#top" title="To the top" id="back" accesskey="t">↑</a>
        <li><a href="#nav">Navigation</a>
        <li><a href="#content">Content</a>
        <li><a href="#comments" accesskey="c">Comments</a>
      </ol>
    </nav>
    <article id="content">
      <header>
        <h1>File search in Node.js</h1>
        <p class="meta">2012-07-12</p>

        <figure class="teaser">
          <img src="magnify.jpg">
        </figure>

      </header>
      <section>
        <p>Since the German blog post <a href="/log/2012/03/volltextsuche.html">Volltextsuche</a> is the most clicked on this blog, I’ll explain, how I realised the full-text search of this website with the help of Node.js.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>You need to be on a Linux/Unix machine, since the search uses native command line commands like <a href="http://en.wikipedia.org/wiki/Find"><code>find</code></a> and <a href="http://en.wikipedia.org/wiki/Grep"><code>grep</code></a> and you need to have <a href="http://nodejs.org/">Node.js</a> (v0.4.0+) installed. Maybe there is a similar way to do it on Windows, too. I think you could install <a href="http://git-scm.com/download">Git for Windows</a> and add the <code>/bin</code> directory to your system <code>PATH</code> to use the same commands on Windows. If somebody has a better solution (maybe one that works out of the box) he/she may <a href="/log/2012/07/file-search-nodejs.html#comments">leave a comment</a>.</p>
<h2 id="finding-files-on-the-command-line">Finding files on the command line</h2>
<p>If you are in a Unix shell, you don’t have a nifty search box, that lets you search for files in your current working directory. Instead, you have the command <code>find</code>, that lets you search for files by specifying various arguments.</p>
<p>For example with <code>find . -name '*.txt'</code> you can search for all files (or directories) ending in <code>.txt</code> in the current working directory and in any subdirectories.</p>
<p><em>But how would you search for the contents of a file?</em></p>
<p>This is quite a bit more difficult to find out. There’s another command, <code>grep</code>, that allows you to filter lines from <code>stdin</code> or from the contents of a given file.</p>
<p>Usually, Unix shells allow you to use the pipe character <code>|</code> to combine commands. This way, you can use <code>find</code> to first find all files of a specific type and the to filter out all the files that contain a specific search string, as follows:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">find</span> <span class="kw">.</span> -name <span class="st">&#39;*.html&#39;</span> <span class="kw">|</span> <span class="kw">xargs</span> <span class="kw">grep</span> <span class="st">&#39;example&#39;</span></code></pre>
<p>The command <code>xargs</code> makes sure, that the results of find are used as arguments for grep, so that it reads the contents of each file. As a result, the command returns a line seperated list of HTML files, that contain the string “example”.</p>
<p>To improve results and prevent errors, the command can still be improved.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">find</span> <span class="kw">.</span> -iname <span class="st">&#39;*.html&#39;</span> <span class="kw">|</span> <span class="kw">xargs</span> <span class="kw">grep</span> <span class="st">&#39;example&#39;</span> -isl</code></pre>
<p>This way, it doesn’t matter if file names are upper- or lowercase and the text search is also case insensitive. Binary content is ignored and warnings will be suppressed.</p>
<h2 id="the-basic-code">The basic code</h2>
<p>Let’s have a look at the required JavaScript code.</p>
<p>What you need to write is a simple HTTP server, that parses the query part of the URL from a HTTP GET request. The search module only takes one parameter, <code>s</code>, like in <code>http://vorb.de/search.html?s=example</code>. This website (vorb.de) uses a small REST framework of mine, <a href="https://github.com/pvorb/node-api">api</a>, which enables me to register modules for different URLs, but I’ll only show how to do it without any framework. This way you can adapt the solution to your framework of choice (<a href="http://expressjs.com/">express</a>, <a href="http://flatironjs.org/">flatiron</a>, <a href="https://github.com/joyent/node/wiki/Modules#wiki-web-frameworks-full">etc.</a>).</p>
<p>You need to load several packages during start-up:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> http = require(<span class="ch">&#39;http&#39;</span>);
<span class="kw">var</span> url = require(<span class="ch">&#39;url&#39;</span>);
<span class="kw">var</span> exec = require(<span class="ch">&#39;child_process&#39;</span>).<span class="fu">exec</span>;</code></pre>
<p>After that, define some other values:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// timeout in ms for a single search</span>
<span class="kw">var</span> timeout = <span class="dv">10000</span>;
<span class="co">// specify the root directory, where the search will begin</span>
<span class="kw">var</span> root = <span class="kw">process</span>.<span class="fu">cwd</span>();</code></pre>
<p>Now you can write the server code:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> server = <span class="kw">http</span>.<span class="fu">createServer</span>(<span class="kw">function</span> (req, resp) {
  <span class="co">// parse the request url</span>
  <span class="co">// the query is everything after the &#39;?&#39;</span>
  <span class="co">// the second param says that the query shall be evaluated</span>
  <span class="kw">var</span> query = <span class="kw">url</span>.<span class="fu">parse</span>(<span class="kw">req</span>.<span class="fu">url</span>, <span class="kw">true</span>).<span class="fu">query</span>;

  <span class="co">// ensure both are != null or &#39;&#39;</span>
<span class="er">  if (query &amp;&amp; query.s) {</span>
    <span class="co">// replace single with double quotes</span>
    <span class="kw">query</span>.<span class="fu">s</span> = <span class="kw">query.s</span>.<span class="fu">replace</span>(<span class="st">&quot;&#39;&quot;</span>, <span class="ch">&#39;&quot;&#39;</span>);

    <span class="co">// run the search</span>
    exec(<span class="st">&quot;find . -iname &#39;*html&#39; | xargs grep &#39;&quot;</span>+query+
        <span class="st">&quot;&#39; -isl&quot;</span>, {
          <span class="dt">timeout</span>: timeout,
          <span class="dt">cwd</span>: root
        }, <span class="kw">function</span> (err, stdout, stdin) {

      <span class="kw">resp</span>.<span class="fu">writeHead</span>(<span class="dv">200</span>, { <span class="ch">&#39;Content-Type&#39;</span>: <span class="ch">&#39;text/html&#39;</span> });

      <span class="kw">if</span> (err) {
        <span class="kw">resp</span>.<span class="fu">end</span>(<span class="ch">&#39;&lt;p&gt;Error on search&lt;/p&gt;&#39;</span>);
        <span class="kw">console</span>.<span class="fu">log</span>(err);
      }

      <span class="co">// split the results</span>
      <span class="kw">var</span> results = <span class="kw">stdout</span>.<span class="fu">split</span>(<span class="ch">&#39;\n&#39;</span>);
      <span class="co">// remove last element (it’s an empty line)</span>
      <span class="kw">results</span>.<span class="fu">pop</span>();

      <span class="kw">resp</span>.<span class="fu">write</span>(<span class="ch">&#39;&lt;h1&gt;Search results&lt;/h1&gt;\n&lt;ul&gt;&#39;</span>);
      <span class="kw">for</span> (<span class="kw">var</span> i = <span class="dv">0</span>; i &lt; <span class="kw">results</span>.<span class="fu">length</span>; i++) {
        <span class="kw">resp</span>.<span class="fu">write</span>(<span class="ch">&#39;&lt;li&gt;&#39;</span>);
        <span class="kw">resp</span>.<span class="fu">write</span>(results[i]);
        <span class="kw">resp</span>.<span class="fu">write</span>(<span class="ch">&#39;&lt;/li&gt;&#39;</span>);
      }
      <span class="kw">resp</span>.<span class="fu">end</span>(<span class="ch">&#39;&lt;/ul&gt;&#39;</span>);
    });
  } <span class="kw">else</span> {
    <span class="kw">resp</span>.<span class="fu">writeHead</span>(<span class="dv">200</span>, { <span class="ch">&#39;Content-Type&#39;</span>: <span class="ch">&#39;text/html&#39;</span> });
    <span class="kw">return</span> <span class="kw">resp</span>.<span class="fu">end</span>(<span class="ch">&#39;&lt;p&gt;No results&lt;/p&gt;&#39;</span>);
  }
});

<span class="co">// listen on port 8080</span>
<span class="kw">server</span>.<span class="fu">listen</span>(<span class="dv">8080</span>, <span class="kw">function</span> () {
  <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Server running at http://localhost:8080/&#39;</span>);
});</code></pre>
<p>You may <a href="file-search.js">download the source file</a>. You can start it on the command line with <code>node file-search.js</code>. Then go to <a href="http://localhost:8080/?s=test">localhost:8080</a> try it. Of course you need to create some HTML files first, if you want to find something.</p>
<p>Here’s how the result will look like:</p>
<div class="figure">
<img src="search-results.png" alt="Screenshot of the search results page" /><p class="caption">Screenshot of the search results page</p>
</div>

      </section>
      <footer class="meta">
        <p>Tags:

          <a href="/log/tag/english.html">english</a> ·

          <a href="/log/tag/dev.html">dev</a> ·

          <a href="/log/tag/nodejs.html">nodejs</a> 

        </p>

        <p>Teaser image from <a href="http://www.flickr.com/photos/l_k_m/1464840438/">Lukas Mathis</a>. License: <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>.</p>

      </footer>
    </article>
    <section id="comments"></section>
    <aside id="extra">
      <form id="sf" action="/search.html" method="GET">
        <input type="search" name="s" accesskey="s" placeholder="Search">
      </form>
    </aside>
    <footer id="about">
      <p>© 2012 – Paul Vorbach.
        <a href="/info/contact.html">Contact</a>.</p>
    </footer>
    <script src="/res/comments.en.min.js"></script>
  </body>
</html>
