server {
  # Redirect users from log.vorb.de to vorb.de/log/
  server_name   log.vorb.de;
  rewrite       ^  http://vorb.de/log$request_uri? permanent;
}

server {
  # Redirect users from www.vorb.de to vorb.de
  server_name   www.vorb.de www.genitis.org genitis.org www.paulvorbach.de paulvorbach.de;
  rewrite       ^  http://vorb.de$request_uri? permanent;
}

server {
  server_name   vorb.de localhost;
  listen        80;
  charset       utf-8;
  index         index.html;

  sendfile    off; # setting for development in VirtualBox

  location / {
    if ($request_method !~ (GET|HEAD)) {
      proxy_pass      http://unix:/tmp/dynamic.socket:;
      expires         off;
    }

    if ($args) {
      proxy_pass      http://unix:/tmp/dynamic.socket:;
      expires         off;
    }

    if ($cookie_lang) {
      proxy_pass      http://unix:/tmp/dynamic.socket:;
      expires         off;
    }

    # first, look for maintenance file, then try the requested uri and if that
    # file does not exist, proxy to @dynamic
    try_files   /info/maintenance.html $uri $uri/index.html $uri/README.html @dynamic;
  }

  # @dynamic is a proxy to a node.js server that must be listening on
  # /tmp/dynamic.socket
  location @dynamic {
    proxy_pass        http://unix:/tmp/dynamic.socket:;
    proxy_buffering   off;
    expires           off;
  }

  root          /var/www/vorb.de/public;

  access_log    /var/www/vorb.de/access.log;
}
